var loadsrc = [
  /*UI图标*/
  //indexUI
  { key: 'header_bg', url: 'https://www.zhanapp.com.cn/img/01/header_TAM.jpg' },
  { key: 'lightning', url: 'https://www.zhanapp.com.cn/img/01/lightning.png' },
  { key: 'integral', url: "https://www.zhanapp.com.cn/img/00/integral.png" },
  { key: 'close', url: "https://www.zhanapp.com.cn/img/01/Close.png" },
  { key: 'jiahao', url: "https://www.zhanapp.com.cn/img/01/+.png" },
  { key: 'Trophy', url: "https://static.zhanapp.com.cn/downloadFile/PHB.png", },
  { key: 'book', url: "https://static.zhanapp.com.cn/downloadFile/HYDZ.png" },
  { key: 'gift', url: "https://static.zhanapp.com.cn/downloadFile/JFZX.png" },
  { key: '卡片图标', url: "https://static.zhanapp.com.cn/downloadFile/kp.png" },
  { key: '设置', url: "https://www.zhanapp.com.cn/img/setting.png" },
  { key: '光芒', url: "https://static.zhanapp.com.cn/downloadFile/mpbgg.png?imageView2/3/w/200/h/200/q/75|imageslim" },
  { key: '恭喜您', url: "https://static.zhanapp.com.cn/downloadFile/mpWinning.png?imageView2/3/w/200/h/200/q/75|imageslim" },
  { key: '恭喜获得一张卡', url: "https://static.zhanapp.com.cn/downloadFile/mphdkp.png?imageView2/3/w/200/h/200/q/75|imageslim" },
  /*等级图标*/
  { key: '青铜', url: 'https://static.zhanapp.com.cn/downloadFile/large/1.png' },
  { key: '白银', url: 'https://static.zhanapp.com.cn/downloadFile/large/2.png' },
  { key: '黄金', url: 'https://static.zhanapp.com.cn/downloadFile/large/3.png' },
  { key: '白金', url: 'https://static.zhanapp.com.cn/downloadFile/large/4.png' },
  { key: '钻石', url: 'https://static.zhanapp.com.cn/downloadFile/large/5.png' },
  { key: '王者联赛', url: 'https://static.zhanapp.com.cn/downloadFile/large/6.png' },
  //等级图标带背景
  { key: '青铜_m', url: 'https://static.zhanapp.com.cn/downloadFile/small/1.png' },
  { key: '白银_m', url: 'https://static.zhanapp.com.cn/downloadFile/small/2.png' },
  { key: '黄金_m', url: 'https://static.zhanapp.com.cn/downloadFile/small/3.png' },
  { key: '白金_m', url: 'https://static.zhanapp.com.cn/downloadFile/small/4.png' },
  { key: '钻石_m', url: 'https://static.zhanapp.com.cn/downloadFile/small/5.png' },
  { key: '王者联赛_m', url: 'https://static.zhanapp.com.cn/downloadFile/small/6.png' },
  { key: '旋转的地球', url: 'https://www.zhanapp.com.cn/img/02/LookingFor.png'},
  { key: 'vsIcon', url: "https://www.zhanapp.com.cn/img/01/vs.png" },
  { key: '锁子', url:'https://static.zhanapp.com.cn/downloadFile/lock3.png'},
  { key: '排位赛背景', url: 'https://static.zhanapp.com.cn/downloadFile/PWSBJ.png' },
  /**/
  { key: '分享图1', url: 'https://static.zhanapp.com.cn/downloadFile/share1.jpg?imageView2/3/w/200/h/200/q/75|imageslim' },
  { key: '分享图2', url: 'https://static.zhanapp.com.cn/downloadFile/share2.jpg?imageView2/3/w/200/h/200/q/75|imageslim' },
  { key: '分享图3', url: 'https://static.zhanapp.com.cn/downloadFile/share3.jpg?imageView2/3/w/200/h/200/q/75|imageslim' },
  { key: '分享图4', url: 'https://static.zhanapp.com.cn/downloadFile/share4.jpg?imageView2/3/w/200/h/200/q/75|imageslim' },
  { key: '分享图5', url: 'https://static.zhanapp.com.cn/downloadFile/share5.jpg?imageView2/3/w/200/h/200/q/75|imageslim' },
  /**/
  { key: 'banner1', url: 'https://static.zhanapp.com.cn/downloadFile/banner/banner1.jpg?imageView2/3/w/200/h/200/q/75|imageslim' },
  { key: 'banner2', url: 'https://static.zhanapp.com.cn/downloadFile/banner/banner2.jpg?imageView2/3/w/200/h/200/q/75|imageslim' },
  { key: 'banner3', url: 'https://static.zhanapp.com.cn/downloadFile/banner/banner3.jpg?imageView2/3/w/200/h/200/q/75|imageslim' },
  { key: 'banner4', url: 'https://static.zhanapp.com.cn/downloadFile/banner/banner4.jpg?imageView2/3/w/200/h/200/q/75|imageslim' },
  { key: 'banner5', url: 'https://static.zhanapp.com.cn/downloadFile/cardmin.jpg?imageView2/3/w/200/h/200/q/75|imageslim'},
  /*奖品window*/
  /*{ key: '奖品窗口', url: 'https://static.zhanapp.com.cn/downloadFile/window.png' },*/
  { key: '奖品窗口2', url: 'https://static.zhanapp.com.cn/downloadFile/window2.png' },
  /*表情*/
  { key: '表情1', url: 'https://www.zhanapp.com.cn/img/04/Expression1.png' },
  { key: '表情2', url: 'https://www.zhanapp.com.cn/img/04/Expression2.png' },
  { key: '表情3', url: 'https://www.zhanapp.com.cn/img/04/Expression3.png' },
  { key: '表情4', url: 'https://www.zhanapp.com.cn/img/04/Expression4.png' },
  { key: '表情5', url: 'https://www.zhanapp.com.cn/img/04/Expression5.png' },
  { key: '表情6', url: 'https://www.zhanapp.com.cn/img/04/Expression6.png' },
  { key: '表情7', url: 'https://www.zhanapp.com.cn/img/04/Expression7.png' },
  { key: '表情8', url: 'https://www.zhanapp.com.cn/img/04/Expression8.png' },
  { key: '表情9', url: 'https://www.zhanapp.com.cn/img/04/Expression9.png' },
  { key: '表情10', url: 'https://www.zhanapp.com.cn/img/04/Expression10.png' },
  { key: '表情背景', url: 'https://www.zhanapp.com.cn/img/04/bubble.png' },
  /* 星星 */
  { key: '黄色星星', url: 'https://www.zhanapp.com.cn/img/01/StarTrue.png' },
  { key: '黑色星星', url: 'https://www.zhanapp.com.cn/img/01/StarFalse.png' },
  { key: '白色星星', url: 'https://www.zhanapp.com.cn/img/01/StarTrue02.png' },
  { key: '王者星星', url: 'https://www.zhanapp.com.cn/img/01/StarTrue03.png' },
  /* 奖杯 */
  { key: '胜利奖杯', url: 'https://www.zhanapp.com.cn/img/04/01.png' },
  { key: '平局奖杯', url: 'https://www.zhanapp.com.cn/img/04/02.png' },
  { key: '失败奖杯', url: 'https://www.zhanapp.com.cn/img/04/03.png' },
  /* AnswerTF */
  { key: '正确', url: 'https://www.zhanapp.com.cn/img/03/true.png' },
  { key: '错误', url: 'https://www.zhanapp.com.cn/img/03/false.png' },
  //mp3区域
  { key: '刀切声音', url: "https://www.zhanapp.com.cn/img/mp3/004.mp3" },
  { key: '正确声音', url: "https://static.zhanapp.com.cn/downloadFile/mp3/01.mp3" },
  { key: '错误声音', url: "https://static.zhanapp.com.cn/downloadFile/mp3/02.mp3" },
  { key: '表情声音', url: "https://static.zhanapp.com.cn/downloadFile/mp3/03.mp3" },
  /* 红包 */
  { key: '红包', url: "https://static.zhanapp.com.cn/downloadFile/hongbao/hongbao.png" },
  { key: '二维码', url: "https://static.zhanapp.com.cn/downloadFile/hongbao/code.png" },
  { key: '红包背景', url: "https://static.zhanapp.com.cn/downloadFile/hongbao/bg.png" }
  
  /*列表等级图标*/
  //{ key: '出类拔萃', url: 'https://www.zhanapp.com.cn/img/level/1.png' },
]

var resources = [], resIndex = 0, App = getApp();
Page({

  /**
   * 页面的初始数据
   */
  data: {
    level:1,
    EXdisplay:false,
    loading_show:"block",
    jpwindos:"none",
    codewindow:false,
    hongbaoindow:false,
    progress_position:0
  },
  oncodeclose:function(){
    this.setData({
      codewindow: false
    })
  },
  saveimg:function(){
    var imgs = wx.getStorageSync('resources');
    wx.saveImageToPhotosAlbum({
      filePath: App.getIcon('二维码', imgs),
      success:function(){
        wx.setClipboardData({
          data: this.data.info.objectId,
          success:function(){
            wx.showModal({
              title: '保存成功',
              content: '添加好友,领取红包.',
              showCancel: false,
              success: function () {
                this.setData({
                  codewindow: false
                })
              }.bind(this)
            })
          }.bind(this)
        })
      }.bind(this)
    })
  },
  oncodewindow:function(){
    this.setData({
      codewindow: true
    })
  },
  ///回复体力
  Porint: function () {
    var info = wx.getStorageSync('zyx_user');
    //(this.data.info.max_power - this.data.info.current_power)
    if (this.data.hp > 0) {
      wx.request({
        url: "https://www.zhanapp.com.cn/api/v1/wxapp/action?action_name=exchange",
        data: "sessiontoken=" + this.data.info.sessiontoken + "&power_point=" + this.data.hp,
        method: "POST",
        header: { "Content-Type": "application/x-www-form-urlencoded;charset=utf-8" },
        success: function (res) {
          info.current_power = res.data.results.current_power
          info.points = res.data.results.points
          wx.setStorageSync('zyx_user', info)

          this.setData({
            info: info
          })

          var pointMax = parseInt(this.data.info.points / 1)
          var hp = (this.data.info.max_power - this.data.info.current_power);

          wx.showModal({
            title: '提示',
            content: '体力 +' + this.data.hp,
            showCancel: false
          })

          this.setData({
            EXdisplay: false,
            hp: (pointMax <= hp ? pointMax : hp)
          })
        }.bind(this)
      })
    } else {
      wx.showModal({
        title: '提示',
        content: '体力已满。',
        showCancel: false
      })
    }
  },
  //载入资源先---------------
  LoadingResources:function(p){
    //重置资源下标
    App.GameData.Loading = true;
    this.setData({
      loading_show: "block"
    })
    resIndex = 0;
    wx.request({
      url: "https://www.zhanapp.com.cn/api/v1/wxapp/version",
      method: "GET",
      header: { "Content-Type": "application/x-www-form-urlencoded;charset=utf-8" },
      success: function (res) {
        var version = res.data.version;
        if (wx.getStorageSync('edition') == version && !p) {
          this.setData({
            loading_show: "none"
          })
          this.startShow();
          App.GameData.Loading = false;
        } else {
          console.log('资源文件更新');
          //获取且清空缓存文件
          var that = this;
          console.log('获取且清空缓存文件');
          wx.getSavedFileList({
            success: function (res) {
              if (res.fileList.length == 0) {
                that.Loading();
              }
              for (var i = 0; i < res.fileList.length; i++) {
                wx.removeSavedFile({
                  filePath: res.fileList[i].filePath,
                  success: function () {
                    if (this == res.fileList.length - 1) {
                      that.Loading(version);
                    }
                  }.bind(i)
                })
              }
            }
          })
          console.log('清空缓存文件完成');

        }
      }.bind(this)
    })
    



  },
  URLOpen(e){
    switch (e.currentTarget.dataset.uid){
      case 0:
        wx.navigateTo({
          url: "./fragment/index"
        })
        break;
      case 1:
        this.setData({
          jpwindos:"block"
        })
        break;
      case 2:
        wx.navigateTo({
          url: "./Luck/index"
        })
        break;
    }
  },
  jpclose: function () {
    this.setData({
      jpwindos: "none"
    })
  },
  Loading: function (version) {
    var that = this;
    //加载资源
    for (var i = 0; i < loadsrc.length; i++) {
      //下载资源头
      wx.downloadFile({
        url: loadsrc[i].url,
        //下载后返回临时文件地址
        success: function (res) {

          //wx.setStorageSync(KEY, DATA)
          //保存文件
          wx.saveFile({
            tempFilePath: res.tempFilePath,
            success: function (res) {
              resources.push({ key: this, url: res.savedFilePath });
              resIndex++;
              that.setData({
                progress_position: parseInt((100 / loadsrc.length) * resIndex)
              })
              if (resIndex == loadsrc.length) {
                wx.setStorageSync('resources', resources);
                wx.setStorageSync('edition', version);
                //跳转到index
                that.startShow();
                App.GameData.Loading = false;
                that.setData({
                  loading_show: "none"
                })
              }
            }.bind(this)
          })
        }.bind(loadsrc[i].key)

        //下载资源尾
      })


    }

  },
  onShow:function () {
    var info = wx.getStorageSync('zyx_user');
    console.log(info);
    if (App.ShareIndexPages(true)){
      if (info) {
        if (App.GameData.state) {
          /*POST上传结果*/
          wx.request({
            url: "https://www.zhanapp.com.cn/api/v1/wxapp/challenge/results",
            data: "sessiontoken=" + this.data.info.sessiontoken + "&challengeId=" + App.GameData.challengeId + "&results= -2&begoodat=" + App.GameData.types.join(','),
            method: "POST",
            header: { "Content-Type": "application/x-www-form-urlencoded;charset=utf-8" },
            success: function (res) {
              console.log(res);
            }
          })
          App.GameData.state = false;
        }

        //更新用户积分体力值数据
        wx.request({
          url: "https://www.zhanapp.com.cn/api/v1/wxapp/user/status?sessiontoken=" + info.sessiontoken,
          method: "GET",
          header: { "Content-Type": "application/x-www-form-urlencoded;charset=utf-8" },
          success: function (res) {
            info.current_power = res.data.results.current_power
            info.points = res.data.results.points
            wx.setStorageSync('zyx_user', info)
            console.log(res);
            //更新数据
            App.GameData.level = res.data.results.level
            App.GameData.current_start = res.data.results.current_start
            this.setData({
              info: info,
              level: res.data.results.level - 1
            })
            console.log(this.data.levelIcon[res.data.results.level - 2])
          }.bind(this)
        })

        this.setData({
          headimgurl: info.headimgurl,
          nameText: info.nickname,
          info: info,
          Gamesound: App.GameData.sound,
        })
      }
    }

  },
  onLoad: function (options) {
    console.log(App.ShareIndexPages(true));
    if (App.ShareIndexPages(true)) {
      //切出Load页面
      App.GameData.LoadingResources = this.LoadingResources;
      this.LoadingResources();
    }
  },
  //开始显示游戏界面
  startShow:function(){
    //资源文件刷新
    var imgs = wx.getStorageSync('resources');

    this.setData({
        jpwindowimg: App.getIcon('奖品窗口2', imgs),
        imgs: {
          header_bg: App.getIcon('header_bg', imgs),//头部背景
          lightning: App.getIcon('lightning', imgs), //闪电
          integral: App.getIcon('integral', imgs),//积分图标
          close: App.getIcon('close', imgs),//关闭图标
          jiahao: App.getIcon('jiahao', imgs),//加号图标
          Trophy: App.getIcon('Trophy', imgs),//奖杯
          book: App.getIcon('卡片图标', imgs),//书
          gift: App.getIcon('gift', imgs),//礼盒
          setting: App.getIcon('设置', imgs),//礼盒
          b_ltbg: App.getIcon('排位赛背景', imgs),//排位赛背景
          hongbao: App.getIcon('红包', imgs),
          hongbaobg: App.getIcon('红包背景', imgs),
          code: App.getIcon('二维码', imgs)
        },
        banner: {
          imgUrls: [
            { img: App.getIcon('banner5', imgs), type: 0 },
            //{ img: App.getIcon('banner3', imgs), type: 0 },
            { img: App.getIcon('banner1', imgs), type: 0 },
            //{ img: App.getIcon('banner2', imgs), type: 1 }
          ],
          indicatorDots: true,
          autoplay: true,
          interval: 5000,
          duration: 500
        },
        levelIcon: [
          { icon: App.getIcon('青铜', imgs), name: "青铜Ⅰ" },
          { icon: App.getIcon('青铜', imgs), name: "青铜Ⅱ" },
          { icon: App.getIcon('青铜', imgs), name: "青铜Ⅲ" },
          { icon: App.getIcon('白银', imgs), name: "白银Ⅰ" },
          { icon: App.getIcon('白银', imgs), name: "白银Ⅱ" },
          { icon: App.getIcon('白银', imgs), name: "白银Ⅲ" },
          { icon: App.getIcon('黄金', imgs), name: "黄金Ⅰ" },
          { icon: App.getIcon('黄金', imgs), name: "黄金Ⅱ" },
          { icon: App.getIcon('黄金', imgs), name: "黄金Ⅲ" },
          { icon: App.getIcon('白金', imgs), name: "白金Ⅰ" },
          { icon: App.getIcon('白金', imgs), name: "白金Ⅱ" },
          { icon: App.getIcon('白金', imgs), name: "白金Ⅲ" },
          { icon: App.getIcon('钻石', imgs), name: "钻石Ⅰ" },
          { icon: App.getIcon('钻石', imgs), name: "钻石Ⅱ" },
          { icon: App.getIcon('钻石', imgs), name: "钻石Ⅲ" },
          { icon: App.getIcon('王者联赛', imgs), name: "王者联赛" }
        ]
    })
    wx.request({
      url: "https://www.zhanapp.com.cn/php/zhanapp-php/exchange.php?uid=" + this.data.info.objectId,
      method: "GET",
      header: { "Content-Type": "application/x-www-form-urlencoded;charset=utf-8" },
      success: function (res) {
        if (res.data.code == 1) {
          this.setData({
            hongbaowindow: true
          })
        }
      }.bind(this)
    })
/*
    var info = wx.getStorageSync('zyx_user');

    //更新用户积分体力值数据
    wx.request({
      url: "https://www.zhanapp.com.cn/api/v1/wxapp/user/status?sessiontoken=" + info.sessiontoken,
      method: "GET",
      header: { "Content-Type": "application/x-www-form-urlencoded;charset=utf-8" },
      success: function (res) {
        info.current_power = res.data.results.current_power
        info.points = res.data.results.points
        wx.setStorageSync('zyx_user', info)
        console.log(res);
        //更新数据
        App.GameData.level = res.data.results.level
        App.GameData.current_start = res.data.results.current_start
        this.setData({
          info: info,
          level: res.data.results.level - 1
        })
      }.bind(this)
    })
    
    //更新数据
    this.setData({
      headimgurl: info.headimgurl,
      nameText: info.nickname
    })*/
  },
  EXSHOW: function (a) {
    var pointMax = parseInt(this.data.info.points / 1)
    var hp = (this.data.info.max_power - this.data.info.current_power);
    this.setData({
      hp: (pointMax <= hp ? pointMax : hp),
      EXdisplay: (a.currentTarget.dataset.buer == 0 ? true : false)
    })
  },
  EXSSHOW: function (a) {
    console.log(a.currentTarget.dataset.buer)
    this.setData({
      EXsetting: (a.currentTarget.dataset.buer == 0 ? true : false)
    })
  },
  soundOP:function(e){
    App.GameData.sound = e.detail.value
  },
  open:function(e){
    switch (e.currentTarget.dataset.name){
      case 'pws':
        App.GameData.scrollButtom = true;
        wx.navigateTo({
          url: "./Dan/index"
        })
      break;
      case 'phb':
        wx.navigateTo({
          url: "./Ranking/index"
        })
      break;
      case 'zsk':
      /*
        wx.showModal({
          title: '维护中',
          showCancel: false,
          content: '即将开启，敬请期待！',
        })
      */
        wx.navigateTo({
          url: "./fragment/index"
        })
        
      break;
      case 'jfzx':
        wx.navigateTo({
          url: "./Luck/index"
        })
      break;
    }
  },
  onclick:function(){
    wx.navigateTo({
      url: "./rule/index?type=0"
    })
  },
  onShareAppMessage: function () {
    //资源文件刷新
    var imgs = wx.getStorageSync('resources');
    var title,img;
    var nbs = parseInt(Math.random() * 4);
    switch (nbs){
      case 0:
        title = '我问你一个文博知识，你能回答吗？';
        img = App.getIcon('分享图1', imgs);
        break;
      case 1:
        title = '这些题的答案,在博物馆里能找到！';
        img = App.getIcon('分享图1', imgs);
        break;
      case 2:
        title = '看展、答题、赢《梵高手册》';
        img = App.getIcon('分享图1' + nbs, imgs);
        break;
      case 3:
        title = '答题赢红包，原来这么简单';
        img = App.getIcon('分享图4', imgs);
        break;
        
    }
    return{
      title: title,
      path: '/pages/Games/index',
      imageUrl: img,
      success:function(res){
        wx.request({
          url: "https://www.zhanapp.com.cn/api/v1/wxapp/action?action_name=share",
          data: "sessiontoken=" + this.data.info.sessiontoken,
          method: "POST",
          header: { "Content-Type": "application/x-www-form-urlencoded;charset=utf-8" },
          success:function(res){
            if(res.data.results.isBounds == 1){
              wx.showModal({
                title: '分享成功',
                content: '体力 +' + res.data.results.bounds_power_points,
                showCancel: false
              })
              this.onShow();
            }else{
              wx.showModal({
                title: '分享成功',
                content: '分享成功！',
                showCancel: false
              })
            };
          }.bind(this)
        })
      }.bind(this),
      fail: function (res) {
        wx.showModal({
          title: '分享失败',
          content: '您可能取消了分享',
          showCancel: false
        })
      }
    }
  }
})